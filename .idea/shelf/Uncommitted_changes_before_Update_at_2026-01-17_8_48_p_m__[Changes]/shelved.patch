Index: src/SqliteCaseRepository.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import java.nio.file.Files;\r\nimport java.nio.file.Path;\r\nimport java.sql.Connection;\r\nimport java.sql.DriverManager;\r\nimport java.sql.PreparedStatement;\r\nimport java.sql.SQLException;\r\nimport java.sql.Statement;\r\nimport java.util.List;\r\nimport java.util.Locale;\r\nimport java.util.Map;\r\n\r\n/**\r\n * Title: SqliteCaseRepository\r\n * Author: Ali Abbas\r\n * Description: SQLite-backed repository for durable case storage and listings.\r\n * Date: Sep 28, 2025\r\n * Version: 1.0.0\r\n */\r\npublic class SqliteCaseRepository implements CaseRepository {\r\n\r\n    private final String dbUrl;\r\n\r\n    public SqliteCaseRepository(Path dbPath) {\r\n        // Ensure the driver is available before any connection attempts.\r\n        ensureDriver();\r\n        this.dbUrl = \"jdbc:sqlite:\" + dbPath.toString();\r\n        ensureDirectory(dbPath);\r\n        ensureSchema();\r\n    }\r\n\r\n    @Override\r\n    public void saveCase(Case c, String sessionId) {\r\n        if (c == null) {\r\n            return;\r\n        }\r\n        String sql = \"INSERT INTO cases (\" +\r\n                \"case_id, session_id, started_epoch_ms, updated_epoch_ms, locked, triage_complete, \" +\r\n                \"triage_level, triage_confidence, duration, duration_minutes, severity, notes_json, \" +\r\n                \"triage_reasons_json, triage_red_flags_json, candidate_confidence_json\" +\r\n                \") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) \" +\r\n                \"ON CONFLICT(case_id) DO UPDATE SET \" +\r\n                \"session_id=excluded.session_id, \" +\r\n                \"updated_epoch_ms=excluded.updated_epoch_ms, \" +\r\n                \"locked=excluded.locked, \" +\r\n                \"triage_complete=excluded.triage_complete, \" +\r\n                \"triage_level=excluded.triage_level, \" +\r\n                \"triage_confidence=excluded.triage_confidence, \" +\r\n                \"duration=excluded.duration, \" +\r\n                \"duration_minutes=excluded.duration_minutes, \" +\r\n                \"severity=excluded.severity, \" +\r\n                \"notes_json=excluded.notes_json, \" +\r\n                \"triage_reasons_json=excluded.triage_reasons_json, \" +\r\n                \"triage_red_flags_json=excluded.triage_red_flags_json, \" +\r\n                \"candidate_confidence_json=excluded.candidate_confidence_json\";\r\n\r\n        try (Connection conn = DriverManager.getConnection(dbUrl);\r\n             PreparedStatement ps = conn.prepareStatement(sql)) {\r\n            int idx = 1;\r\n            ps.setString(idx++, c.caseId);\r\n            ps.setString(idx++, sessionId);\r\n            ps.setLong(idx++, c.startedEpochMs);\r\n            ps.setLong(idx++, System.currentTimeMillis());\r\n            ps.setInt(idx++, c.locked ? 1 : 0);\r\n            ps.setInt(idx++, c.triageComplete ? 1 : 0);\r\n            ps.setString(idx++, c.triageLevel);\r\n            ps.setDouble(idx++, c.triageConfidence);\r\n            ps.setString(idx++, c.duration);\r\n            ps.setDouble(idx++, c.durationMinutes);\r\n            ps.setString(idx++, c.severity);\r\n            ps.setString(idx++, toJsonArray(c.notes));\r\n            ps.setString(idx++, toJsonArray(c.triageReasons));\r\n            ps.setString(idx++, toJsonArray(c.triageRedFlags));\r\n            ps.setString(idx++, toJsonMap(c.candidateConfidenceByCode));\r\n            ps.executeUpdate();\r\n        } catch (SQLException e) {\r\n            System.out.println(\"[SqliteCaseRepository] Failed to save case: \" + e.getMessage());\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public List<CaseSummary> listCases(int limit) {\r\n        List<CaseSummary> summaries = new java.util.ArrayList<>();\r\n        // Query only the fields required for the database list view.\r\n        String sql = \"SELECT case_id, session_id, started_epoch_ms, triage_level, triage_confidence, \" +\r\n                \"duration, severity, notes_json, triage_red_flags_json \" +\r\n                \"FROM cases ORDER BY started_epoch_ms DESC LIMIT ?\";\r\n        try (Connection conn = DriverManager.getConnection(dbUrl);\r\n             PreparedStatement ps = conn.prepareStatement(sql)) {\r\n            ps.setInt(1, limit);\r\n            try (java.sql.ResultSet rs = ps.executeQuery()) {\r\n                while (rs.next()) {\r\n                    String caseId = rs.getString(\"case_id\");\r\n                    String sessionId = rs.getString(\"session_id\");\r\n                    long startedEpochMs = rs.getLong(\"started_epoch_ms\");\r\n                    String triageLevel = rs.getString(\"triage_level\");\r\n                    double triageConfidence = rs.getDouble(\"triage_confidence\");\r\n                    String duration = rs.getString(\"duration\");\r\n                    String severity = rs.getString(\"severity\");\r\n                    String notesJson = rs.getString(\"notes_json\");\r\n                    String redFlagsJson = rs.getString(\"triage_red_flags_json\");\r\n                    int notesCount = countArrayItems(notesJson);\r\n                    int redFlagCount = countArrayItems(redFlagsJson);\r\n                    summaries.add(new CaseSummary(caseId, sessionId, startedEpochMs, triageLevel, triageConfidence, duration, severity, notesCount, redFlagCount));\r\n                }\r\n            }\r\n        } catch (SQLException e) {\r\n            System.out.println(\"[SqliteCaseRepository] Failed to list cases: \" + e.getMessage());\r\n        }\r\n        return summaries;\r\n    }\r\n\r\n    private void ensureDirectory(Path dbPath) {\r\n        try {\r\n            Path parent = dbPath.getParent();\r\n            if (parent != null) {\r\n                Files.createDirectories(parent);\r\n            }\r\n        } catch (Exception e) {\r\n            System.out.println(\"[SqliteCaseRepository] Failed to create data directory: \" + e.getMessage());\r\n        }\r\n    }\r\n\r\n    private void ensureSchema() {\r\n        String ddl = \"CREATE TABLE IF NOT EXISTS cases (\" +\r\n                \"case_id TEXT PRIMARY KEY, \" +\r\n                \"session_id TEXT, \" +\r\n                \"started_epoch_ms INTEGER, \" +\r\n                \"updated_epoch_ms INTEGER, \" +\r\n                \"locked INTEGER, \" +\r\n                \"triage_complete INTEGER, \" +\r\n                \"triage_level TEXT, \" +\r\n                \"triage_confidence REAL, \" +\r\n                \"duration TEXT, \" +\r\n                \"duration_minutes REAL, \" +\r\n                \"severity TEXT, \" +\r\n                \"notes_json TEXT, \" +\r\n                \"triage_reasons_json TEXT, \" +\r\n                \"triage_red_flags_json TEXT, \" +\r\n                \"candidate_confidence_json TEXT\" +\r\n                \")\";\r\n        try (Connection conn = DriverManager.getConnection(dbUrl);\r\n             Statement stmt = conn.createStatement()) {\r\n            stmt.execute(ddl);\r\n        } catch (SQLException e) {\r\n            throw new IllegalStateException(\"Failed to initialize schema: \" + e.getMessage(), e);\r\n        }\r\n    }\r\n\r\n    private void ensureDriver() {\r\n        try {\r\n            Class.forName(\"org.sqlite.JDBC\");\r\n        } catch (ClassNotFoundException e) {\r\n            throw new IllegalStateException(\"SQLite JDBC driver not found.\", e);\r\n            System.out.println(\"[SqliteCaseRepository] Failed to initialize schema: \" + e.getMessage());\r\n        }\r\n    }\r\n\r\n    private String toJsonArray(List<String> values) {\r\n        StringBuilder sb = new StringBuilder();\r\n        sb.append(\"[\");\r\n        for (int i = 0; i < values.size(); i++) {\r\n            if (i > 0) sb.append(\",\");\r\n            sb.append(\"\\\"\").append(escapeJson(values.get(i))).append(\"\\\"\");\r\n        }\r\n        sb.append(\"]\");\r\n        return sb.toString();\r\n    }\r\n\r\n    private String toJsonMap(Map<String, Double> values) {\r\n        StringBuilder sb = new StringBuilder();\r\n        sb.append(\"{\");\r\n        int i = 0;\r\n        for (Map.Entry<String, Double> entry : values.entrySet()) {\r\n            if (i++ > 0) sb.append(\",\");\r\n            sb.append(\"\\\"\").append(escapeJson(entry.getKey())).append(\"\\\":\");\r\n            sb.append(String.format(Locale.ROOT, \"%.4f\", entry.getValue()));\r\n        }\r\n        sb.append(\"}\");\r\n        return sb.toString();\r\n    }\r\n\r\n    private int countArrayItems(String jsonArray) {\r\n        if (jsonArray == null || jsonArray.isBlank()) {\r\n            return 0;\r\n        }\r\n        int count = 0;\r\n        boolean inString = false;\r\n        boolean escape = false;\r\n        for (int i = 0; i < jsonArray.length(); i++) {\r\n            char c = jsonArray.charAt(i);\r\n            if (escape) {\r\n                escape = false;\r\n                continue;\r\n            }\r\n            if (c == '\\\\') {\r\n                escape = true;\r\n                continue;\r\n            }\r\n            if (c == '\"') {\r\n                inString = !inString;\r\n                if (!inString) {\r\n                    count++;\r\n                }\r\n            }\r\n        }\r\n        return count;\r\n    }\r\n\r\n    private String escapeJson(String s) {\r\n        if (s == null) return \"\";\r\n        return s.replace(\"\\\\\", \"\\\\\\\\\")\r\n                .replace(\"\\\"\", \"\\\\\\\"\")\r\n                .replace(\"\\n\", \"\\\\n\")\r\n                .replace(\"\\r\", \"\\\\r\");\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/SqliteCaseRepository.java b/src/SqliteCaseRepository.java
--- a/src/SqliteCaseRepository.java	(revision b0417e960c768f2c853d6b9eb74a53aad342c0a9)
+++ b/src/SqliteCaseRepository.java	(date 1768700169262)
@@ -151,7 +151,6 @@
             Class.forName("org.sqlite.JDBC");
         } catch (ClassNotFoundException e) {
             throw new IllegalStateException("SQLite JDBC driver not found.", e);
-            System.out.println("[SqliteCaseRepository] Failed to initialize schema: " + e.getMessage());
         }
     }
 
Index: src/CaseRepository.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>/**\r\n * Title: CaseRepository\r\n * Author: Ali Abbas\r\n * Description: Storage abstraction for saving cases and listing summary data.\r\n * Date: Sep 28, 2025\r\n * Version: 1.0.0\r\n */\r\npublic interface CaseRepository {\r\n    // Persist a case to the active storage backend.\r\n    void saveCase(Case c, String sessionId);\r\n\r\n    // Return lightweight summaries for recent cases (used by the Database tab).\r\n    java.util.List<CaseSummary> listCases(int limit);\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CaseRepository.java b/src/CaseRepository.java
--- a/src/CaseRepository.java	(revision b0417e960c768f2c853d6b9eb74a53aad342c0a9)
+++ b/src/CaseRepository.java	(date 1768700100714)
@@ -6,7 +6,6 @@
  * Version: 1.0.0
  */
 public interface CaseRepository {
-    // Persist a case to the active storage backend.
     void saveCase(Case c, String sessionId);
 
     // Return lightweight summaries for recent cases (used by the Database tab).
Index: .idea/misc.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"ProjectRootManager\" version=\"2\" languageLevel=\"JDK_24\" default=\"true\" project-jdk-name=\"openjdk-24\" project-jdk-type=\"JavaSDK\">\r\n    <output url=\"file://$PROJECT_DIR$/out\" />\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/misc.xml b/.idea/misc.xml
--- a/.idea/misc.xml	(revision b0417e960c768f2c853d6b9eb74a53aad342c0a9)
+++ b/.idea/misc.xml	(date 1768700100771)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <project version="4">
-  <component name="ProjectRootManager" version="2" languageLevel="JDK_24" default="true" project-jdk-name="openjdk-24" project-jdk-type="JavaSDK">
+  <component name="ProjectRootManager" version="2" languageLevel="JDK_25" project-jdk-name="openjdk-24" project-jdk-type="JavaSDK">
     <output url="file://$PROJECT_DIR$/out" />
   </component>
 </project>
\ No newline at end of file
